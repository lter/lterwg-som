theme_bw() # save 6 x 12
# Align root and soil data, need to assign horizon to roots
somNEONMegaRootsSel <- somNEONMegaRoots %>%
select_if(not_all_na)
somNEONMegaSoilSel <- somNEON %>%
filter(data_file%in%c("megapit_soils_all")) %>%
select_if(not_all_na)
## JL loop to assign horizons - takes a min or two to run
results.list = list()
for (site in somNEONMegaRoots$site_code) {
df.roots.oneSite = somNEONMegaRoots %>%
filter(site_code == site)
df.soil.oneSite = somNEONMegaSoil %>%
filter(site_code == site)
site.horizons = c()
# loop through each midpoint for a given site
for (midpoint in df.roots.oneSite$layer_mid) {
midpoint.horizon = NA
# get the horizon for a given midpoint
for (horizon in df.soil.oneSite$hzn) {
df.soil.oneSite.oneHorizon = df.soil.oneSite %>%
filter(hzn == horizon)
if ((midpoint > df.soil.oneSite.oneHorizon$layer_top[1]) &
(midpoint <= df.soil.oneSite.oneHorizon$layer_bot[1])) {
midpoint.horizon = horizon
}
}
# All the horizons for a given site stored in a vector
site.horizons = c(site.horizons, midpoint.horizon)
}
results.list[[site]] = tibble(layer_mid = df.roots.oneSite$layer_mid,
hzn = site.horizons,
site_code = site)
}
horizon.dat = bind_rows(results.list)
# Add horizon to megapit roots, select
somNEONMegaRootsSel <- somNEONMegaRootsSel %>%
left_join(horizon.dat, by = c("site_code", "layer_mid"))
# Sum roots by horizon
somNEONMegaRootsSel.byHor <- somNEONMegaRootsSel %>%
group_by(site_code, hzn) %>%
summarize(bgb_c_stock = sum(bgb_c_stock, na.rm = T))
# Join to soil data - **********USE THIS DF TO COMPARE OTHER EDAPHIC VARS TO ROOTS*************
somNEONMegaSoil.withRoot <- somNEONMegaSoilSel %>%
left_join(somNEONMegaRootsSel.byHor, by = c("site_code", "hzn")) %>%
mutate(hzn_type = ifelse(grepl("^O", hzn), "organic", "mineral"))
# Whole profile summed (summed across combined organic and mineral horizons)
# Covariates are added to the df at a later step.
somNEONMegaSoil.withRoot.Profile <- somNEONMegaSoil.withRoot %>%
group_by(site_code) %>%
summarize(bgb_c_stock_sum = sum(bgb_c_stock, na.rm = T),
lyr_soc_stock_calc_sum = sum(lyr_soc_stock_calc, na.rm = T),
land_cover = first(land_cover),
eco_region = first(eco_region)) %>%
filter(bgb_c_stock_sum > 1)
# Whole profile summed (only for mineral horizons)
# Covariates are added to the df at a later step.
somNEONMegaSoil.withRoot.Profile.min <- somNEONMegaSoil.withRoot %>%
filter(hzn_type=="mineral") %>%
group_by(site_code) %>%
summarize(bgb_c_stock_sum = sum(bgb_c_stock, na.rm = T),
lyr_soc_stock_calc_sum = sum(lyr_soc_stock_calc, na.rm = T),
land_cover = first(land_cover),
eco_region = first(eco_region)) %>%
filter(bgb_c_stock_sum > 1)
#cum sum for root C stocks, contains cumulative fractions for soc & bgb and also whole profile sums
somNEONMegaRootsSelSumDepth <- somNEONMegaRootsSel %>%
left_join(dplyr::select(somNEONMegaSoil.withRoot.Profile, site_code, bgb_c_stock_sum),by="site_code") %>%
mutate(rootfrac = round((bgb_c_stock/bgb_c_stock_sum),2)) %>%
group_by(site_code) %>%
mutate(rootfrac_cumsum = round(cumsum(rootfrac),2))
#cum sum for SOC stocks
somNEONMegaSoilSelSumDepth <- somNEONMegaSoilSel %>%
left_join(dplyr::select(somNEONMegaSoil.withRoot.Profile, site_code, lyr_soc_stock_calc_sum),by="site_code") %>%
mutate(socfrac = round((lyr_soc_stock_calc/lyr_soc_stock_calc_sum),2)) %>%
group_by(site_code) %>%
filter(!is.na(socfrac)) %>%
mutate(socfrac_cumsum = round(cumsum(socfrac),2))
#combine the cumsum dataframes, now root cumsum and soc cumsum are in the same dataframe with exact layer_bot for the measures
somNEONMegaSoilRootSelSumDepth<- somNEONMegaSoilSelSumDepth %>%
rbind(somNEONMegaRootsSelSumDepth) #%>%
#pre-lim quick plots for root beta curves
somNEONMega1 <-  somNEONMegaSoilRootSelSumDepth %>%
filter(site_code%in%neonSiteList1) %>%
arrange(land_cover)
somNEONMega2 <- somNEONMegaSoilRootSelSumDepth %>%
filter(!site_code%in%neonSiteList1)
#Jessica's stats section
library(lmerTest) # provides sig test for lmer models
library(sjstats) #for psuedo-R2 in lmer models
library(car) #for Anova
library(MASS) #for stepAIC
#Calculating covariates
somNEONMegaSoilRootCovariates <- somNEONMegaSoil.withRoot %>% # somNEONMegaSoilRootSelSumDepth %>%
group_by(site_code) %>%
summarize(mat = mean(mat, na.rm = T),
map = mean(map, na.rm = T),
clay = mean(clay, na.rm=T),
layer_bot_max = max(layer_bot, na.rm=T))
# Join covariates
somNEONMegaSoilRoot_wholeprofilestats <- somNEONMegaSoil.withRoot.Profile %>%
left_join(somNEONMegaSoilRootCovariates, by="site_code")
#remove shrublands
somNEONMegaSoilRoot_wholeprofilestats_noshrub <- somNEONMegaSoilRoot_wholeprofilestats %>%
filter(land_cover!="shrubland")
#remove the three high root outliers
somNEONMegaSoilRoot_wholeprofilestats_NoOut <-somNEONMegaSoilRoot_wholeprofilestats %>%
filter(!site_code %in% c("HEAL","BARR","WREF"))
#Calculating covariates
somNEONMegaSoilRootCovariates <- somNEONMegaSoil.withRoot %>% # somNEONMegaSoilRootSelSumDepth %>%
group_by(site_code) %>%
summarize(mat = mean(mat, na.rm = T),
map = mean(map, na.rm = T),
clay = mean(clay, na.rm=T),
layer_bot_max = max(layer_bot, na.rm=T))
# Join covariates
somNEONMegaSoilRoot_wholeprofilestats <- somNEONMegaSoil.withRoot.Profile %>%
left_join(somNEONMegaSoilRootCovariates, by="site_code")
#remove shrublands
somNEONMegaSoilRoot_wholeprofilestats_noshrub <- somNEONMegaSoilRoot_wholeprofilestats %>%
filter(land_cover!="shrubland")
#remove the three high root outliers
somNEONMegaSoilRoot_wholeprofilestats_NoOut <-somNEONMegaSoilRoot_wholeprofilestats %>%
filter(!site_code %in% c("HEAL","BARR","WREF"))
#Add mycorrhizal type
mycodb<-read.csv("MycoDB_version4.csv")
View(somNEONMegaSoilRoot_wholeprofilestats)
View(somNEONMegaSoil.withRoot)
#Calculating covariates
somNEONMegaSoilRootCovariates <- somNEONMegaSoil.withRoot %>% # somNEONMegaSoilRootSelSumDepth %>%
group_by(site_code) %>%
summarize(mat = mean(mat, na.rm = T),
map = mean(map, na.rm = T),
clay = mean(clay, na.rm=T),
layer_bot_max = max(layer_bot, na.rm=T),
veg_note_profile = first(veg_note_profile))
# Join covariates
somNEONMegaSoilRoot_wholeprofilestats <- somNEONMegaSoil.withRoot.Profile %>%
left_join(somNEONMegaSoilRootCovariates, by="site_code")
somNEONMegaSoilRoot_wholeprofilestats_myc<-separate(somNEONMegaSoilRoot_wholeprofilestats, col="veg_note_profile", remove=F, sep=",", into=c("veg1","veg2","veg3"), extra="warn", fill="warn")
View(somNEONMegaSoilRoot_wholeprofilestats_myc)
somNEONMegaSoilRoot_wholeprofilestats_myc<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
mutate(myc = if_else(contains(veg1 %in% mycodb$PlantSpecies),mycodb$MYCORRHIZAETYPE,NA))
View(mycodb)
somNEONMegaSoilRoot_wholeprofilestats_myc<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
mutate(myc = if_else(contains(veg1 %in% mycodb$PlantSpecies2018),mycodb$MYCORRHIZAETYPE,NA))
str(mycodb$PlantSpecies2018)
str(somNEONMegaSoilRoot_wholeprofilestats_myc$veg1)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg1<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg1)
str(somNEONMegaSoilRoot_wholeprofilestats_myc$veg1)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg2<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg2)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg3<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg3)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg1<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg1)
str(somNEONMegaSoilRoot_wholeprofilestats_myc$veg1)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg2<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg2)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg3<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg3)
somNEONMegaSoilRoot_wholeprofilestats_myc<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
mutate(myc = if_else(match(veg1 %in% mycodb$PlantSpecies2018),mycodb$MYCORRHIZAETYPE,NA))
somNEONMegaSoilRoot_wholeprofilestats_myc<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
left_join(mycodb, dplyr::select(PlantSpecies2018, MYCORRHIZAETYPE), by=c("veg1"="PlantSpecies2018"))
View(somNEONMegaSoilRoot_wholeprofilestats_myc)
somNEONMegaSoilRoot_wholeprofilestats_myc<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
left_join(dplyr::select(mycodb, PlantSpecies2018, MYCORRHIZAETYPE), by=c("veg1"="PlantSpecies2018"))
View(somNEONMegaSoilRoot_wholeprofilestats_myc)
#re-formatting to match
somNEONMegaSoilRoot_wholeprofilestats_myc<-separate(somNEONMegaSoilRoot_wholeprofilestats, col="veg_note_profile", remove=F, sep=", ", into=c("veg1","veg2","veg3"), extra="warn", fill="warn")
somNEONMegaSoilRoot_wholeprofilestats_myc$veg1<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg1) #placing underscores between genus and species names
somNEONMegaSoilRoot_wholeprofilestats_myc$veg2<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg2)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg3<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg3)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg1<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg1)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg2<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg2)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg3<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg3)
somNEONMegaSoilRoot_wholeprofilestats_myc<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
left_join(dplyr::select(mycodb, PlantSpecies2018, MYCORRHIZAETYPE), by=c("veg1"="PlantSpecies2018"))
View(somNEONMegaSoilRoot_wholeprofilestats)
# Join covariates
somNEONMegaSoilRoot_wholeprofilestats <- somNEONMegaSoil.withRoot.Profile %>%
left_join(somNEONMegaSoilRootCovariates, by="site_code") %>%
filter(!is.na(veg_note_profile))
#re-formatting to match
somNEONMegaSoilRoot_wholeprofilestats_myc<-separate(somNEONMegaSoilRoot_wholeprofilestats, col="veg_note_profile", remove=F, sep=", ", into=c("veg1","veg2","veg3"), extra="warn", fill="warn")
somNEONMegaSoilRoot_wholeprofilestats_myc$veg1<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg1) #placing underscores between genus and species names
somNEONMegaSoilRoot_wholeprofilestats_myc$veg2<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg2)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg3<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg3)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg1<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg1)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg2<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg2)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg3<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg3)
View(somNEONMegaSoilRoot_wholeprofilestats_myc)
somNEONMegaSoilRoot_wholeprofilestats_myc<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
left_join(dplyr::select(mycodb, PlantSpecies2018, MYCORRHIZAETYPE), by=c("veg1"="PlantSpecies2018"))
#re-formatting to match
somNEONMegaSoilRoot_wholeprofilestats_myc<-separate(somNEONMegaSoilRoot_wholeprofilestats, col="veg_note_profile", remove=F, sep=", ", into=c("veg1","veg2","veg3"), extra="warn", fill="warn")
somNEONMegaSoilRoot_wholeprofilestats_myc$veg1<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg1) #placing underscores between genus and species names
somNEONMegaSoilRoot_wholeprofilestats_myc$veg2<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg2)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg3<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg3)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg1<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg1)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg2<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg2)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg3<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg3)
somNEONMegaSoilRoot_wholeprofilestats_myc<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
inner_join(dplyr::select(mycodb, PlantSpecies2018, MYCORRHIZAETYPE), by=c("veg1"="PlantSpecies2018"))
#re-formatting to match
somNEONMegaSoilRoot_wholeprofilestats_myc<-separate(somNEONMegaSoilRoot_wholeprofilestats, col="veg_note_profile", remove=F, sep=", ", into=c("veg1","veg2","veg3"), extra="warn", fill="warn")
somNEONMegaSoilRoot_wholeprofilestats_myc$veg1<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg1) #placing underscores between genus and species names
somNEONMegaSoilRoot_wholeprofilestats_myc$veg2<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg2)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg3<-gsub(" ", "_", somNEONMegaSoilRoot_wholeprofilestats_myc$veg3)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg1<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg1)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg2<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg2)
somNEONMegaSoilRoot_wholeprofilestats_myc$veg3<-tolower(somNEONMegaSoilRoot_wholeprofilestats_myc$veg3)
somNEONMegaSoilRoot_wholeprofilestats_mycjoin<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
left_join(dplyr::select(mycodb, PlantSpecies2018, MYCORRHIZAETYPE), by=c("veg1"="PlantSpecies2018"))
mycodb<-filter(mycodb, !is.na(MYCORRHIZAETYPE))
somNEONMegaSoilRoot_wholeprofilestats_mycjoin<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
left_join(dplyr::select(mycodb, PlantSpecies2018, MYCORRHIZAETYPE), by=c("veg1"="PlantSpecies2018"))
View(somNEONMegaSoilRoot_wholeprofilestats_mycjoin)
mycodb_sum<- mycodb %>%filter(!is.na(MYCORRHIZAETYPE)) %>%
group_by(PlantSpecies2018) %>%
summarize(myc = first(MYCORRHIZAETYPE),
PlantSpecies2018 = first(PlantSpecies2018))
mycodb_sum<- mycodb %>% filter(!is.na(MYCORRHIZAETYPE)) %>%
filter(!is.na(PlantSpecies2018)) %>%
group_by(PlantSpecies2018) %>%
summarize(myc = first(MYCORRHIZAETYPE),
PlantSpecies2018 = first(PlantSpecies2018))
mycodb_sum<- mycodb %>% filter(!is.na(MYCORRHIZAETYPE)) %>%
filter(!is.na(PlantSpecies2018)) %>%
group_by(PlantSpecies2018) %>%
summarize(myc = first(MYCORRHIZAETYPE))
View(mycodb_sum)
somNEONMegaSoilRoot_wholeprofilestats_mycjoin<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
left_join(dplyr::select(mycodb_sum, PlantSpecies2018, myc), by=c("veg1"="PlantSpecies2018"))
View(mycodb)
somNEONMegaSoilRoot_wholeprofilestats_mycjoin<-somNEONMegaSoilRoot_wholeprofilestats_myc %>%
left_join(dplyr::select(mycodb_sum, PlantSpecies2018, myc), by=c("veg1"="PlantSpecies2018")) %>%
ifelse(myc=="NA", left_join(dplyr::select(mycodb_sum, PlantSpecies2018, myc), by=c("veg2"="PlantSpecies2018")))
write.csv(somNEONMegaSoilRoot_wholeprofilestats_myc, "somNEONMegaSoilRoot_wholeprofilestats_myc.csv")
write.csv(somNEONMegaSoilRoot_wholeprofilestats_mycjoin, "somNEONMegaSoilRoot_wholeprofilestats_mycjoin.csv")
somNEONMegaSoilRoot_wholeprofilestats_mycjoin<-read.csv("somNEONMegaSoilRoot_wholeprofilestats_mycjoin.csv")
#### AVNI'S AGU TALK
### Results for Objective 1: Whole profile summed SOC correlated with Roots (whole profile summed) and other covariates
null.mod <- lmer(data=somNEONMegaSoilRoot_wholeprofilestats_mycjoin, lyr_soc_stock_calc_sum ~ (1|layer_bot_max))
full.mod<-lmer(data=somNEONMegaSoilRoot_wholeprofilestats_mycjoin, lyr_soc_stock_calc_sum ~
bgb_c_stock_sum + mat  + clay + land_cover + myc + (1|layer_bot_max)) #too many eco_regions to analyze
summary(full.mod)
Anova(full.mod)
anova(full.mod, null.mod)
#Reduced model, dropping MAP because it is not significant, making land_cover a random effect
reduced.mod2<-lmer(data=somNEONMegaSoilRoot_wholeprofilestats_NoOut, lyr_soc_stock_calc_sum ~
bgb_c_stock_sum + mat + clay + land_cover + myc + (1|layer_bot_max))
#Reduced model, dropping MAP because it is not significant, making land_cover a random effect
reduced.mod2<-lmer(data=somNEONMegaSoilRoot_wholeprofilestats_mycjoin, lyr_soc_stock_calc_sum ~
bgb_c_stock_sum + mat + clay + land_cover + myc + (1|layer_bot_max))
summary(reduced.mod2)
Anova(reduced.mod2)
#Reduced model, dropping MAP because it is not significant, making land_cover a random effect
reduced.mod2<-lmer(data=somNEONMegaSoilRoot_wholeprofilestats_mycjoin, lyr_soc_stock_calc_sum ~
bgb_c_stock_sum + mat + clay  + myc + (1|layer_bot_max))
Anova(reduced.mod2)
#Reduced model, dropping MAP because it is not significant, making land_cover a random effect
reduced.mod2<-lmer(data=somNEONMegaSoilRoot_wholeprofilestats_mycjoin, lyr_soc_stock_calc_sum ~
bgb_c_stock_sum  + myc + (1|layer_bot_max))
Anova(reduced.mod2)
#Reduced model, dropping MAP because it is not significant, making land_cover a random effect
reduced.mod2<-lmer(data=somNEONMegaSoilRoot_wholeprofilestats_mycjoin, lyr_soc_stock_calc_sum ~
myc + (1|layer_bot_max))
Anova(reduced.mod2)
#Reduced model, dropping MAP because it is not significant, making land_cover a random effect
reduced.mod2<-lmer(data=somNEONMegaSoilRoot_wholeprofilestats_mycjoin, lyr_soc_stock_calc_sum ~
mat + myc + (1|layer_bot_max))
Anova(reduced.mod2)
someNEON$site_code[which(somNEON$bgb_upperdiam==4)
]
somNEON$site_code[which(somNEON$bgb_upperdiam==4)]
unique(somNEON$site_code[which(somNEON$bgb_upperdiam==4)])
unique(somNEON$site_code[which(somNEON$bgb_upperdiam==2)])
##################################
### Data Exploration: LTER-SOM ###
###    Sept 2019, SWeintraub   ###
##################################
#Avni edits
### Reset workspace
rm(list = ls())
### Set paths
if (file.exists('/Users/sweintraub/')){
dir1 <- ("/Users/sweintraub/Documents/GitHub/lterwg-som/")
}
if (file.exists('/Users/5a7/')){
dir1 <- ("/Users/5a7/Documents/GitHub/lterwg-som/")
}
if (file.exists('C:/Users/vishr_000')){
dir1 <- ("C:/Users/vishr_000/Documents/GitHub/lterwg-som/")
}
dir1
source(paste0(dir1,'data-processing/get_latest_som.R'))
som <- get_latest_som() #HINT: Select 0 and re-authorize the google api each time. Not sure why the pre-auth isn't working.
som <- get_latest_som() #HINT: Select 0 and re-authorize the google api each time. Not sure why the pre-auth isn't working.
# filter to only NEON
somNEON <- filter(som, network == "NEON")
landCov <- select(somNEON, land_cover, site_code)
# useful function for making the DF smaller, only keep variables with not all NA
not_all_na <- function(x) any(!is.na(x))
#subsetting neon sites into groups for easier plotting
neonSiteList1 <- c("BART",
"HARV",
"SCBI",
"SERC",
"BLAN",
"DSNY",
"OSBS",
"JERC",
"LAJA",
"GUAN",
"STEI",
"UNDE",
"TREE",
"UKFS",
"KONZ",
"KONA",
"GRSM",
"MLBS",
"ORNL",
"DELA",
"TALL",
"WOOD",
"DCFS")
# Megapits - creating dataframes for making plots, carbon with depth, roots and soil
# have to include 4 diam because otherwise some sites would be lost
somNEONMegaRoots <- somNEON %>%
filter(data_file%in%c("megapit_roots"),
bgb_upperdiam%in%c("2","4"),
bgb_type == "live") %>%
mutate(bgb_c = ifelse(is.na(bgb_c), 52, bgb_c),
bgb_c_stock = bgb*(bgb_c*.01)) # c_stock is (g root C)/m2
somNEONMegaSoil <- somNEON %>%
filter(data_file%in%c("megapit_soils_all"))
# Putting roots and soil together into one column
somNEONMega <- bind_rows(somNEONMegaRoots, somNEONMegaSoil) %>%
mutate(carbon_stock = ifelse(data_file=="megapit_roots",
bgb_c_stock,
lyr_soc_stock_calc)) %>% #divide by 100 for graphing, but do analyses without dividing by 100; lyr_soc_stock_calc is (g C)/m2
select_if(not_all_na) %>%
arrange(site_code)
sum(is.na(somNEONMega$carbon_stock)) # 6 rows have no C
#subset dfs, half of neon sites
somNEONMega1 <- somNEONMega %>%
filter(site_code%in%neonSiteList1)
somNEONMega2 <- somNEONMega %>%
filter(!site_code%in%neonSiteList1)
# Align root and soil data, need to assign horizon to roots
somNEONMegaRootsSel <- somNEONMegaRoots %>%
select_if(not_all_na)
somNEONMegaSoilSel <- somNEON %>%
filter(data_file%in%c("megapit_soils_all")) %>%
select_if(not_all_na)
## JL loop to assign horizons - takes a min or two to run
results.list = list()
for (site in somNEONMegaRoots$site_code) {
df.roots.oneSite = somNEONMegaRoots %>%
filter(site_code == site)
df.soil.oneSite = somNEONMegaSoil %>%
filter(site_code == site)
site.horizons = c()
# loop through each midpoint for a given site
for (midpoint in df.roots.oneSite$layer_mid) {
midpoint.horizon = NA
# get the horizon for a given midpoint
for (horizon in df.soil.oneSite$hzn) {
df.soil.oneSite.oneHorizon = df.soil.oneSite %>%
filter(hzn == horizon)
if ((midpoint > df.soil.oneSite.oneHorizon$layer_top[1]) &
(midpoint <= df.soil.oneSite.oneHorizon$layer_bot[1])) {
midpoint.horizon = horizon
}
}
# All the horizons for a given site stored in a vector
site.horizons = c(site.horizons, midpoint.horizon)
}
results.list[[site]] = tibble(layer_mid = df.roots.oneSite$layer_mid,
hzn = site.horizons,
site_code = site)
}
horizon.dat = bind_rows(results.list)
# Add horizon to megapit roots, select
somNEONMegaRootsSel <- somNEONMegaRootsSel %>%
left_join(horizon.dat, by = c("site_code", "layer_mid"))
# Sum roots by horizon
somNEONMegaRootsSel.byHor <- somNEONMegaRootsSel %>%
group_by(site_code, hzn) %>%
summarize(bgb_c_stock = sum(bgb_c_stock, na.rm = T))
# Join to soil data - **********USE THIS DF TO COMPARE OTHER EDAPHIC VARS TO ROOTS*************
somNEONMegaSoil.withRoot <- somNEONMegaSoilSel %>%
left_join(somNEONMegaRootsSel.byHor, by = c("site_code", "hzn")) %>%
mutate(hzn_type = ifelse(grepl("^O", hzn), "organic", "mineral"))
# Whole profile summed (summed across combined organic and mineral horizons)
# Covariates are added to the df at a later step.
somNEONMegaSoil.withRoot.Profile <- somNEONMegaSoil.withRoot %>%
group_by(site_code) %>%
summarize(bgb_c_stock_sum = sum(bgb_c_stock, na.rm = T),
lyr_soc_stock_calc_sum = sum(lyr_soc_stock_calc, na.rm = T),
land_cover = first(land_cover),
eco_region = first(eco_region)) %>%
filter(bgb_c_stock_sum > 1)
# Whole profile summed (only for mineral horizons)
# Covariates are added to the df at a later step.
somNEONMegaSoil.withRoot.Profile.min <- somNEONMegaSoil.withRoot %>%
filter(hzn_type=="mineral") %>%
group_by(site_code) %>%
summarize(bgb_c_stock_sum = sum(bgb_c_stock, na.rm = T),
lyr_soc_stock_calc_sum = sum(lyr_soc_stock_calc, na.rm = T),
land_cover = first(land_cover),
eco_region = first(eco_region)) %>%
filter(bgb_c_stock_sum > 1)
#cum sum for root C stocks, contains cumulative fractions for soc & bgb and also whole profile sums
somNEONMegaRootsSelSumDepth <- somNEONMegaRootsSel %>%
left_join(dplyr::select(somNEONMegaSoil.withRoot.Profile, site_code, bgb_c_stock_sum),by="site_code") %>%
mutate(rootfrac = round((bgb_c_stock/bgb_c_stock_sum),2)) %>%
group_by(site_code) %>%
mutate(rootfrac_cumsum = round(cumsum(rootfrac),2))
#cum sum for SOC stocks
somNEONMegaSoilSelSumDepth <- somNEONMegaSoilSel %>%
left_join(dplyr::select(somNEONMegaSoil.withRoot.Profile, site_code, lyr_soc_stock_calc_sum),by="site_code") %>%
mutate(socfrac = round((lyr_soc_stock_calc/lyr_soc_stock_calc_sum),2)) %>%
group_by(site_code) %>%
filter(!is.na(socfrac)) %>%
mutate(socfrac_cumsum = round(cumsum(socfrac),2))
#combine the cumsum dataframes, now root cumsum and soc cumsum are in the same dataframe with exact layer_bot for the measures
somNEONMegaSoilRootSelSumDepth<- somNEONMegaSoilSelSumDepth %>%
rbind(somNEONMegaRootsSelSumDepth) #%>%
#pre-lim quick plots for root beta curves
somNEONMega1 <-  somNEONMegaSoilRootSelSumDepth %>%
filter(site_code%in%neonSiteList1) %>%
arrange(land_cover)
somNEONMega2 <- somNEONMegaSoilRootSelSumDepth %>%
filter(!site_code%in%neonSiteList1)
#Calculating covariates
somNEONMegaSoilRootCovariates <- somNEONMegaSoil.withRoot %>% # somNEONMegaSoilRootSelSumDepth %>%
group_by(site_code) %>%
summarize(mat = mean(mat, na.rm = T),
map = mean(map, na.rm = T),
clay = mean(clay, na.rm=T),
layer_bot_max = max(layer_bot, na.rm=T),
veg_note_profile = first(veg_note_profile))
# Join covariates
somNEONMegaSoilRoot_wholeprofilestats <- somNEONMegaSoil.withRoot.Profile %>%
left_join(somNEONMegaSoilRootCovariates, by="site_code") %>%
filter(!is.na(veg_note_profile))
#Reduced model, dropping MAP because it is not significant, making land_cover a random effect
reduced.mod2<-lmer(data=somNEONMegaSoilRoot_wholeprofilestats_NoOut, lyr_soc_stock_calc_sum ~
mat  + (1|layer_bot_max))
Anova(reduced.mod2)
#remove the three high root outliers
somNEONMegaSoilRoot_wholeprofilestats_NoOut <-somNEONMegaSoilRoot_wholeprofilestats %>%
filter(!site_code %in% c("HEAL","BARR","WREF"))
#Reduced model, dropping MAP because it is not significant, making land_cover a random effect
reduced.mod2<-lmer(data=somNEONMegaSoilRoot_wholeprofilestats_NoOut, lyr_soc_stock_calc_sum ~
mat  + (1|layer_bot_max))
Anova(reduced.mod2)
#Figure 1
write.csv(somNEONMegaSoilRoot_wholeprofilestats, "somNEONMegaSoilRoot_wholeprofilestats.csv")
fig1_ecoreg <- ggplot(data=somNEONMegaSoilRoot_wholeprofilestats, aes(x=bgb_c_stock_sum/1000, y=lyr_soc_stock_calc_sum/1000))+
geom_smooth(method=lm, color="black")+
geom_point(pch=21, size=3, aes(fill = eco_region))+ # alternatively, add aes(fill=land_cover)
scale_fill_manual(values=c("darkgreen","tan4","springgreen1","sienna3","tan","dodgerblue","gray"))+
xlab(bquote(Whole-profile~root~biomass~(kg~C~m^-2)))+
ylab(bquote(Whole-profile~soil~organic~C~(kg~C~m^-2)))+
guides(fill=guide_legend(title="Land Cover", ncol=1, title.theme = element_text(size=14, angle=0), label.theme = element_text(size=14, angle=0)))+
theme(legend.position="right", panel.grid.major=element_blank(),panel.grid.minor=element_blank(),panel.border=element_rect(fill=NA, color="black"),panel.background=element_rect(fill="white"),axis.title=element_text(size=16),axis.text=element_text(size=14))
fig1_ecoreg
#Dataframe with site_code, hzn_type, bgb_c_stock_sum, and lyr_soc_stock_calc_sum
somNEONMegaSoil.withRoot.Profile.hzn <- somNEONMegaSoil.withRoot %>%
group_by(site_code, hzn_type) %>%
summarize(bgb_c_stock_sum = sum(bgb_c_stock, na.rm = T),
lyr_soc_stock_calc_sum = sum(lyr_soc_stock_calc, na.rm = T),
land_cover = first(land_cover))
#Grab covariates
somNEONMegaSoilRootCovariates.hzn <- somNEONMegaSoil.withRoot %>%
group_by(site_code, hzn_type) %>%
summarize(mat = mean(mat, na.rm = T),
map = mean(map, na.rm = T),
clay = mean(clay, na.rm=T), #clay is averaged across the whole profile
layer_bot_max = max(layer_bot, na.rm=T)) #max depth is a random effect
#Join the horizon-specific profile sums to the covariate table
somNEONMegaSoil.withRoot.Profile.hzn.stats <- somNEONMegaSoil.withRoot.Profile.hzn %>%
left_join(somNEONMegaSoilRootCovariates.hzn, by=c("site_code", "hzn_type"))
#split the dataframes
somNEON_organic_wholeprofile <- filter(somNEONMegaSoil.withRoot.Profile.hzn.stats, hzn_type=="organic")
somNEON_mineral_wholeprofile <- filter(somNEONMegaSoil.withRoot.Profile.hzn.stats, hzn_type=="mineral")
#Figure 2
fig2_landcov <- ggplot(data=somNEON_organic_wholeprofile, aes(x=bgb_c_stock_sum/1000, y=lyr_soc_stock_calc_sum/1000))+
geom_smooth(method=lm, color="black")+
geom_point(aes(fill=land_cover), pch=21, size=3)+
xlab(bquote(Organic-profile~root~biomass~(kg~C~m^-2)))+
ylab(bquote(Organic-profile~soil~organic~C~(kg~C~m^-2)))+
guides(fill=guide_legend(title="Land Cover", ncol=2, title.theme = element_text(size=12, angle=0), label.theme = element_text(size=12, angle=0)))+
theme(legend.position=c(0.3,0.85), legend.box.background = element_rect(color = "black"), panel.grid.major=element_blank(),panel.grid.minor=element_blank(),panel.border=element_rect(fill=NA, color="black"),panel.background=element_rect(fill="white"),axis.title=element_text(size=14),axis.text.x=element_text(size=12),axis.text.y=element_text(size=12))
fig2_landcov
#Figure 2
fig3_hzn <- ggplot(data=somNEONMegaSoil.withRoot.Profile.hzn.stats, aes(x=bgb_c_stock_sum/1000, y=lyr_soc_stock_calc_sum/1000))+
geom_smooth(method=lm, aes(color=hzn_type), alpha=0.3)+
geom_point(aes(fill = hzn_type), pch=21, size=4)+
scale_fill_manual(values=c("black","gray"))+
scale_color_manual(values=c("black","gray"), guide="none")+
xlab(bquote(Root~biomass~(kg~C~m^-2)))+
ylab(bquote(Soil~organic~C~(kg~C~m^-2)))+
guides(fill=guide_legend(title="Horizon", title.theme = element_text(size=14, angle=0), label.theme = element_text(size=14, angle=0)))+
theme(legend.position=c(0.85,0.85), panel.grid.major=element_blank(),panel.grid.minor=element_blank(),panel.border=element_rect(fill=NA, color="black"),panel.background=element_rect(fill="white"),axis.title=element_text(size=16),axis.text.x=element_text(size=14),axis.text.y=element_text(size=14))
fig3_hzn
citation(minqa)
citation("minqa")
citation("lmer")
citation("lmerTest")
citation("sjstats")
str(somNEON$bgb_c)
