##################################
### Data Exploration: LTER-SOM ###
###    Sept 2019, SWeintraub   ###
##################################
#Avni edits
### Reset workspace
rm(list = ls())
if (file.exists('/Users/5a7/')){
dir1 <- ("/Users/5a7/Documents/GitHub/lterwg-som/")
}
dir1
### Load data - straight from google drive
library(googledrive)
library(tidyverse)
source(paste0(dir1,'data-processing/get_latest_som.R'))
som <- get_latest_som()
som <- get_latest_som()
som <- get_latest_som()
t
if (file.exists('/Users/5a7/')){
dir1 <- ("/Users/5a7/Documents/GitHub/lterwg-som/")
}
source(paste0(dir1,'data-processing/get_latest_som.R'))
som <- get_latest_som()
som <- get_latest_som()
read.delim("ENDO_tax.txt")
setwd("~/Documents/CreggerLDRD/150MemComm")
ESV<-read.delim("ENDO_tax.txt")
library(dplyr)
ESV<-read.delim("ENDO_tax.txt")
setwd("~/Documents/GitHub/lterwg-som/root_group_analyses")
##################################
### Data Exploration: LTER-SOM ###
###    Sept 2019, SWeintraub   ###
##################################
#Avni edits
### Reset workspace
rm(list = ls())
if (file.exists('/Users/5a7/')){
dir1 <- ("/Users/5a7/Documents/GitHub/lterwg-som/")
}
dir1
### Load data - straight from google drive
library(googledrive)
library(tidyverse)
library(dplyr)
library(ggplot2)
source(paste0(dir1,'data-processing/get_latest_som.R'))
som <- get_latest_som() #HINT: Select 0 and re-authorize the google api each time. Not sure why the pre-auth isn't working.
som <- get_latest_som() #HINT: Select 0 and re-authorize the google api each time. Not sure why the pre-auth isn't working.
##################################
### Data Exploration: LTER-SOM ###
###    Sept 2019, SWeintraub   ###
##################################
#Avni edits
### Reset workspace
rm(list = ls())
if (file.exists('/Users/5a7/')){
dir1 <- ("/Users/5a7/Documents/GitHub/lterwg-som/")
}
source(paste0(dir1,'data-processing/get_latest_som.R'))
som <- get_latest_som() #HINT: Select 0 and re-authorize the google api each time. Not sure why the pre-auth isn't working.
# filter to only NEON
somNEON <- filter(som, network == "NEON")
landCov <- select(somNEON, land_cover, site_code)
# useful function for making the DF smaller, only keep variables with not all NA
not_all_na <- function(x) any(!is.na(x))
#subsetting neon sites into groups for easier plotting
neonSiteList1 <- c("BART",
"HARV",
"SCBI",
"SERC",
"BLAN",
"DSNY",
"OSBS",
"JERC",
"LAJA",
"GUAN",
"STEI",
"UNDE",
"TREE",
"UKFS",
"KONZ",
"KONA",
"GRSM",
"MLBS",
"ORNL",
"DELA",
"TALL",
"WOOD",
"DCFS")
# Megapits - creating dataframes for making plots, carbon with depth, roots and soil
# have to include 4 diam because otherwise some sites would be lost
somNEONMegaRoots <- somNEON %>%
filter(data_file%in%c("megapit_roots"),
bgb_upperdiam%in%c("2","4"),
bgb_type == "live") %>%
mutate(bgb_c = ifelse(is.na(bgb_c), 52, bgb_c),
bgb_c_stock = bgb*(bgb_c*.01)) # c_stock is (g root C)/m2
somNEONMegaSoil <- somNEON %>%
filter(data_file%in%c("megapit_soils_all"))
# Putting roots and soil together into one column
somNEONMega <- bind_rows(somNEONMegaRoots, somNEONMegaSoil) %>%
mutate(carbon_stock = ifelse(data_file=="megapit_roots",
bgb_c_stock,
lyr_soc_stock_calc)) %>% #divide by 100 for graphing, but do analyses without dividing by 100; lyr_soc_stock_calc is (g C)/m2
select_if(not_all_na) %>%
arrange(site_code)
sum(is.na(somNEONMega$carbon_stock)) # 6 rows have no C
#subset dfs, half of neon sites
somNEONMega1 <- somNEONMega %>%
filter(site_code%in%neonSiteList1)
somNEONMega2 <- somNEONMega %>%
filter(!site_code%in%neonSiteList1)
# Align root and soil data, need to assign horizon to roots
somNEONMegaRootsSel <- somNEONMegaRoots %>%
select_if(not_all_na)
somNEONMegaSoilSel <- somNEON %>%
filter(data_file%in%c("megapit_soils_all")) %>%
select_if(not_all_na)
## JL loop to assign horizons - takes a min or two to run
results.list = list()
for (site in somNEONMegaRoots$site_code) {
df.roots.oneSite = somNEONMegaRoots %>%
filter(site_code == site)
df.soil.oneSite = somNEONMegaSoil %>%
filter(site_code == site)
site.horizons = c()
# loop through each midpoint for a given site
for (midpoint in df.roots.oneSite$layer_mid) {
midpoint.horizon = NA
# get the horizon for a given midpoint
for (horizon in df.soil.oneSite$hzn) {
df.soil.oneSite.oneHorizon = df.soil.oneSite %>%
filter(hzn == horizon)
if ((midpoint > df.soil.oneSite.oneHorizon$layer_top[1]) &
(midpoint <= df.soil.oneSite.oneHorizon$layer_bot[1])) {
midpoint.horizon = horizon
}
}
# All the horizons for a given site stored in a vector
site.horizons = c(site.horizons, midpoint.horizon)
}
results.list[[site]] = tibble(layer_mid = df.roots.oneSite$layer_mid,
hzn = site.horizons,
site_code = site)
}
horizon.dat = bind_rows(results.list)
# Add horizon to megapit roots, select
somNEONMegaRootsSel <- somNEONMegaRootsSel %>%
left_join(horizon.dat, by = c("site_code", "layer_mid"))
# Sum roots by horizon
somNEONMegaRootsSel.byHor <- somNEONMegaRootsSel %>%
group_by(site_code, hzn) %>%
summarize(bgb_c_stock = sum(bgb_c_stock, na.rm = T))
# Join to soil data - **********USE THIS DF TO COMPARE OTHER EDAPHIC VARS TO ROOTS*************
somNEONMegaSoil.withRoot <- somNEONMegaSoilSel %>%
left_join(somNEONMegaRootsSel.byHor, by = c("site_code", "hzn")) %>%
mutate(hzn_type = ifelse(grepl("^O", hzn), "organic", "mineral"))
# Whole profile summed (summed across combined organic and mineral horizons)
# Covariates are added to the df at a later step.
somNEONMegaSoil.withRoot.Profile <- somNEONMegaSoil.withRoot %>%
group_by(site_code) %>%
summarize(bgb_c_stock_sum = sum(bgb_c_stock, na.rm = T),
lyr_soc_stock_calc_sum = sum(lyr_soc_stock_calc, na.rm = T),
land_cover = first(land_cover),
eco_region = first(eco_region)) %>%
filter(bgb_c_stock_sum > 1)
# Whole profile summed (only for mineral horizons)
# Covariates are added to the df at a later step.
somNEONMegaSoil.withRoot.Profile.min <- somNEONMegaSoil.withRoot %>%
filter(hzn_type=="mineral") %>%
group_by(site_code) %>%
summarize(bgb_c_stock_sum = sum(bgb_c_stock, na.rm = T),
lyr_soc_stock_calc_sum = sum(lyr_soc_stock_calc, na.rm = T),
land_cover = first(land_cover),
eco_region = first(eco_region)) %>%
filter(bgb_c_stock_sum > 1)
#cum sum for root C stocks, contains cumulative fractions for soc & bgb and also whole profile sums
somNEONMegaRootsSelSumDepth <- somNEONMegaRootsSel %>%
left_join(select(somNEONMegaSoil.withRoot.Profile, site_code, bgb_c_stock_sum),by="site_code") %>%
mutate(rootfrac = round((bgb_c_stock/bgb_c_stock_sum),2)) %>%
group_by(site_code) %>%
mutate(rootfrac_cumsum = round(cumsum(rootfrac),2))
#cum sum for SOC stocks
somNEONMegaSoilSelSumDepth <- somNEONMegaSoilSel %>%
left_join(select(somNEONMegaSoil.withRoot.Profile, site_code, lyr_soc_stock_calc_sum),by="site_code") %>%
mutate(socfrac = round((lyr_soc_stock_calc/lyr_soc_stock_calc_sum),2)) %>%
group_by(site_code) %>%
filter(!is.na(socfrac)) %>%
mutate(socfrac_cumsum = round(cumsum(socfrac),2))
#combine the cumsum dataframes, now root cumsum and soc cumsum are in the same dataframe with exact layer_bot for the measures
somNEONMegaSoilRootSelSumDepth<- somNEONMegaSoilSelSumDepth %>%
rbind(somNEONMegaRootsSelSumDepth) #%>%
somNEONMega2 <- somNEONMegaSoilRootSelSumDepth %>%
filter(!site_code%in%neonSiteList1)
#Jessica's stats section
library(lmerTest) # provides sig test for lmer models
library(sjstats) #for psuedo-R2 in lmer models
library(car) #for Anova
#Calculating covariates
somNEONMegaSoilRootCovariates <- somNEONMegaSoil.withRoot %>% # somNEONMegaSoilRootSelSumDepth %>%
group_by(site_code) %>%
summarize(mat = mean(mat, na.rm = T),
map = mean(map, na.rm = T),
clay = mean(clay, na.rm=T),
layer_bot_max = max(layer_bot, na.rm=T))
# Join covariates
somNEONMegaSoilRoot_wholeprofilestats <- somNEONMegaSoil.withRoot.Profile %>%
left_join(somNEONMegaSoilRootCovariates, by="site_code")
#Obj 1 using a multiple regression instead of mixed model
mod<-lm(data=somNEONMegaSoilRoot_wholeprofilestats, lyr_soc_stock_calc_sum ~
mat + clay + land_cover + layer_bot_max)
library(MASS) #for stepAIC
summary(mod)
#remove shrublands
somNEONMegaSoilRoot_wholeprofilestats_noshrub <- somNEONMegaSoilRoot_wholeprofilestats %>%
filter(land_cover!="shrubland")
#Obj 1b: using a multiple regression instead of mixed model to directly test layer_bot_max effect
mod<-lm(data=somNEONMegaSoilRoot_wholeprofilestats_noshrub, lyr_soc_stock_calc_sum ~
mat + clay + land_cover + layer_bot_max)
summary(mod)
#Obj 1b: using a multiple regression instead of mixed model to directly test layer_bot_max effect
mod<-lm(data=somNEONMegaSoilRoot_wholeprofilestats_noshrub, lyr_soc_stock_calc_sum ~ bgb_c_stock_sum +
mat + clay + land_cover + layer_bot_max)
summary(mod)
Anova(mod)
install.packages("ppcor")
library(ppcor)
pcor(mod)
#method2: multiple regression
t.values <- mod$coeff / sqrt(diag(vcov(mod)))
partcorr <- sqrt((t.values^2) / ((t.values^2) + mod$df.residual))
partcorr
